
@{
    ViewBag.Title = "Index";
}

<div class="container">
    <h2 class="title-room">超新打字王</h2>
    @Html.Hidden("username", (string)ViewBag.Username)


    <div id="messageBox">
        <div class="row">

            <ul class="collapsible" data-collapsible="accordion" style="margin:0 2%;">
                <li>
                    <div class="collapsible-header"><i class="material-icons">filter_drama</i>題目</div>
                    <div class="collapsible-body blue-text darken-4" style="font-size:16px;">
                        <textarea type="text" id="quiz"></textarea>
                        <span class="right"> x <span id="times"></span>(重複次數)</span>
                        <br />
                            <a class="waves-effect waves-light btn right" id="startGamebtn"><i class="material-icons left">play_arrow</i>開始遊戲</a>
                            <a class="waves-effect waves-light btn red right hide" id="stopGamebtn"><i class="material-icons left">stop</i>停止</a><br />
                    </div>
                </li>
            </ul>
        </div>

        <div class="row">
            <ul class="collection" id="gameul"></ul>
        </div>
    </div>

    <div id="chatList">
        <p><u>在線清單  (<span id="onlineCount"></span>人)</u></p>
        <ul id="list" class="collection"></ul>
    </div>
    <div id="bar">
        <div class="row">
            <div class="input-field col s12">
                <textarea id="typingtext" class="materialize-textarea type-textarea" data-length=""></textarea>
                <label for="typingtext" style="padding-left:5px;">打字方塊</label>
            </div>
        </div>
        <div class="row inProgressDiv">
            <div class="col s11">
                <div class="progress blue lighten-3">
                    <div class="determinate blue darken-3"></div>
                </div>
            </div>
            <div class="right">
                計時 <span id="timer">0.000</span> s
            </div>
        </div>
    </div>

</div>

<!-- Modal Structure -->
<div id="modal1" class="modal">
    <div class="modal-content">
        <h3>準備開始</h3>
        <h4>遊戲將在<span id="timeleft"></span>秒後開始</h4>
    </div>
</div>
<!-- Modal Structure -->
<div id="modal2" class="modal">
    <div class="modal-content">
        <h3 id="winText"></h3>
        <img src="~/Content/images/winner.jpg" />
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat green lighten-4">喔知道了</a>
    </div>
</div>
<!-- Chat Box-->
@Html.Partial("_PartialChatBox")


@section css{
    <link href="~/Content/css/gamecss.css" rel="stylesheet" />
    <link href="~/Content/css/chatbox.css" rel="stylesheet" />
}

@section scripts{
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>

    <script src="~/Scripts/chatbox.js"></script>

    <script>

        var imageRootPath = '@Url.Content("~/Content/images/")';

        var connectionId = "";
        var username = document.getElementById("username").value;
        var quiz = "";
        var times = 1;
        var interval;
        var isGameStart = false;

        var gameHub = $.connection.gameHub;
        var chatHub = $.connection.chatHub;

        $(function () {

            $('.modal').modal({
                dismissible: false
            });

            registerClientMethods(gameHub);
            registerChatClientMethods(chatHub);


            $.connection.hub.start().done(function () {
                gameHub.server.onConnected(username);
                connectionId = $.connection.hub.id;

                registerEvents(gameHub);
                registerChatEvent(chatHub);
            });
        });


        function registerClientMethods(gameHub) {
            //--- 建立連線後，我們接著來定義client端的function來讓Server端的hub呼叫。 ---
            //取得所有上線使用者清單
            gameHub.client.getList = function (userList) {

                var people = 0;
                var li = "";
                var peopleli = "";
                $.each(userList, function (index, data) {

                    li += "<i class='material-icons'>perm_identity</i><li class='collection-item' id='" + data.Id + "'>" + data.Name + "<span class='right'>積分: " + data.Game.Score + "</span></li>";
                    people++;

                    var strIndex = index.toString();

                    // 加入遊戲Typing欄位

                    peopleli +=
                        '   <li class ="collection-item avatar"> \
                              <img src="' + imageRootPath + strIndex[strIndex.length - 1] + '.png" class="circle responsive-img" height="42" width="42" /> \
                              <span class ="title">' + data.Name + '</span> \
                              <p id="typed-' + data.Id + '">\
                                 ' + data.Game.InputText + ' \
                              </p> \
                              <a href="#!" class ="secondary-content"><i class ="material-icons">grade</i></a> \
                            </li> \
                       ';

                    if (data.Id == connectionId) {
                        //是自己就更新打字方塊內的文字
                        $('#typingtext').val(data.Game.InputText);
                        $(".type-textarea").css("border", "1px solid #808080");
                        if (data.Game.InputText == "") {
                            $(".type-textarea").fadeIn("fast", function () {
                                $(".type-textarea").css("border", "1px solid red");
                            });

                        }
                    }
                });

                $("#list").html(li);
                $("#gameul").html(peopleli);

                $("#onlineCount").text(people);
            };

            //新增一筆上線人員
            gameHub.client.join = function (name, gameStatus) {
                toastr.success(name + " 加入囉");
            };
            //移除一筆上線人員
            gameHub.client.leaves = function (name) {
                toastr.error(name + " 離開了");
            };
            //接收題目更新
            gameHub.client.refreshQuiz = function (quiz, times) {
                $("#quiz").text(quiz);
                $("#times").text(times);
                $("#typingtext").attr('data-length', quiz.repeat(times).length);
                $("#typingtext").characterCounter();
                toastr.info("題目更新囉!");
            }
            //接收遊戲開始了
            gameHub.client.gameStart = function () {
                var second = 5;
                $('#modal1').modal('open');

                var leftinterval = setInterval(function () {
                    $("#timeleft").text(second);

                    if (second == 0) {
                        clearInterval(leftinterval);
                        $('#modal1').modal('close');
                        startGame();
                    }
                    second--;
                }, 1000)
            }
            //接收遊戲結束了
            gameHub.client.gameStop = function () {
                if (isGameStart) {
                    stopGame();
                }
            }
            //接收勝利者出爐
            gameHub.client.gameInfo = function (winner) {
                if (isGameStart) {
                    stopGame();
                    $('#winText').text(winner);
                    $('#modal2').modal('open');
                }
            }
        }


        function registerEvents(gameHub) {
            //初始化題目
            gameHub.server.refreshQuiz(quiz, times);

            // jquery 禁止copy
            $('#typingtext').bind('cut copy paste', function (e) {
                e.preventDefault(); //disable cut,copy,paste
            });

            // 改變typing textarea內容
            $('#typingtext').bind('input propertychange', function () {
                gameHub.server.gameCheck($(this).val());
            });

            $('#startGamebtn').on('click', function () {
                gameHub.server.startGame();
            });
            $('#stopGamebtn').on('click', function () {
                gameHub.server.stopGame();
            });
            $('#quiz').on('change', function () {
                gameHub.server.refreshQuiz($(this).val(), times);
            });

        }

        function startGame() {
            isGameStart = true;
            $('#typingtext').val('');

            $('#typingtext').focus();
            $('#startGamebtn').toggleClass('hide');
            $('#stopGamebtn').toggleClass('hide');

            var startTime = Date.now();

            interval = setInterval(function () {
                var elapsedTime = Date.now() - startTime;
                document.getElementById("timer").innerHTML = (elapsedTime / 1000).toFixed(3);

            }, 100);

            $(".progress > div").toggleClass("determinate indeterminate");
        }

        function stopGame() {
            isGameStart = false;
            $('#typingtext').val('');

            $('#startGamebtn').toggleClass('hide');
            $('#stopGamebtn').toggleClass('hide');

            clearInterval(interval);

            $(".progress > div").toggleClass("determinate indeterminate");
        }
    </script>



}